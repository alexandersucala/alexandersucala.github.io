<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Assistant V2 - Alexander Sucala</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .page-header {
            width: 100%;
            max-width: 1200px;
            padding: 12px 0;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .page-header h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
            margin-bottom: 4px;
        }
        
        .page-header .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }
        
        .page-header .subtitle {
            font-size: 12px;
            opacity: 0.6;
            font-weight: 300;
        }
        
        .page-header .disclaimer {
            margin-top: 8px;
            font-size: 11px;
            opacity: 0.5;
            font-weight: 300;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            height: calc(100vh - 140px);
            background: #000000;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #000000;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            display: flex;
            justify-content: flex-end;
        }
        
        .message.assistant {
            display: flex;
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 12px;
            line-height: 1.7;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            color: #000000;
            font-weight: 400;
        }
        
        .message.assistant .message-content {
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #2a2a2a;
        }
        
        .metadata-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .confidence-high {
            background: #10b981;
            color: #ffffff;
        }
        
        .confidence-medium {
            background: #f59e0b;
            color: #ffffff;
        }
        
        .confidence-low {
            background: #ef4444;
            color: #ffffff;
        }
        
        .policy-pass {
            background: #10b981;
            color: #ffffff;
        }
        
        .policy-rewrite {
            background: #f59e0b;
            color: #000000;
        }
        
        .policy-fail {
            background: #ef4444;
            color: #ffffff;
        }
        
        .report-type {
            background: #6366f1;
            color: #ffffff;
        }
        
        .report-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2a2a2a;
        }
        
        .report-section h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #60a5fa;
            letter-spacing: 0.5px;
        }
        
        .report-section p {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .report-section ul {
            margin-left: 20px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .report-section ul li {
            margin-bottom: 6px;
        }
        
        .followup-buttons {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2a2a2a;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .followup-btn {
            padding: 8px 14px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            color: #ffffff;
            font-size: 12px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .followup-btn:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .followup-btn:active {
            transform: translateY(0);
        }
        
        .citations {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2a2a2a;
        }
        
        .citations-title {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
            color: #888;
        }
        
        .citation-link {
            display: block;
            font-size: 12px;
            color: #60a5fa;
            text-decoration: none;
            margin-bottom: 8px;
            transition: color 0.2s;
        }
        
        .citation-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
        }
        
        .loading-dots span {
            width: 6px;
            height: 6px;
            background: #60a5fa;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1);
            }
        }
        
        .welcome-message {
            text-align: center;
            padding: 60px 20px;
        }
        
        .welcome-message h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }
        
        .welcome-message p {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        
        .example-questions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .example-btn {
            padding: 12px 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #ffffff;
            font-size: 13px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
        }
        
        .example-btn:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        
        .example-btn:active {
            transform: translateY(0);
        }
        
        .input-container {
            padding: 20px;
            background: #0a0a0a;
            border-top: 1px solid #1a1a1a;
            display: flex;
            gap: 12px;
        }
        
        #userInput {
            flex: 1;
            padding: 14px 18px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            color: #ffffff;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }
        
        #userInput:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        
        #userInput::placeholder {
            color: #666;
        }
        
        #sendBtn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border: none;
            border-radius: 10px;
            color: #ffffff;
            font-size: 13px;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        
        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(96, 165, 250, 0.4);
        }
        
        #sendBtn:active {
            transform: translateY(0);
        }
        
        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            color: #ef4444;
            font-weight: 500;
            padding: 12px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .trace-id {
            font-size: 10px;
            opacity: 0.4;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>Finance Assistant<span class="version-badge">V2</span></h1>
        <p class="subtitle">Fail-closed AI stock analysis with compliance gates / Alexander Sucala</p>
        <p class="disclaimer">‚ö†Ô∏è Educational only - Not financial advice</p>
    </div>

    <div class="container">
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <h2>ASK ABOUT ANY STOCK</h2>
                <p>V2 features 3-stage LLM pipeline with dual compliance gates<br>
                Complete auditability ‚Ä¢ Quality scoring ‚Ä¢ Deterministic output</p>
                
                <div class="example-questions">
                    <button class="example-btn" onclick="askQuestion('What is driving NVDA today?')">NVIDIA DRIVERS</button>
                    <button class="example-btn" onclick="askQuestion('Analyze TSLA risk factors')">TESLA RISKS</button>
                    <button class="example-btn" onclick="askQuestion('Compare AAPL vs MSFT fundamentals')">COMPARE</button>
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                id="userInput" 
                placeholder="Ask about a stock or type a ticker..." 
                onkeypress="if(event.key==='Enter') sendMessage()"
            >
            <button onclick="sendMessage()" id="sendBtn">SEND</button>
        </div>
    </div>
    
    <script>
        // Configure API endpoint - UPDATE THIS WITH YOUR RAILWAY URL
        const API_URL = 'https://finance-assistant-v2-backend-production.up.railway.app';
        
        // ========================================================================
        // TICKER EXTRACTION - FIXED (handles lowercase company names + symbols)
        // ========================================================================
        const COMPANY_MAP = {
            // Big Tech
            'apple': 'AAPL', 'aapl': 'AAPL',
            'microsoft': 'MSFT', 'msft': 'MSFT',
            'google': 'GOOGL', 'alphabet': 'GOOGL', 'googl': 'GOOGL', 'goog': 'GOOGL',
            'amazon': 'AMZN', 'amzn': 'AMZN',
            'meta': 'META', 'facebook': 'META',
            'nvidia': 'NVDA', 'nvda': 'NVDA',
            'tesla': 'TSLA', 'tsla': 'TSLA',
            'netflix': 'NFLX', 'nflx': 'NFLX',
            // Semiconductors
            'amd': 'AMD', 'advanced micro': 'AMD',
            'intel': 'INTC', 'intc': 'INTC',
            'qualcomm': 'QCOM', 'qcom': 'QCOM',
            'broadcom': 'AVGO', 'avgo': 'AVGO',
            'tsmc': 'TSM', 'tsm': 'TSM',
            // Finance
            'jpmorgan': 'JPM', 'jp morgan': 'JPM', 'jpm': 'JPM',
            'goldman': 'GS', 'goldman sachs': 'GS', 'gs': 'GS',
            'berkshire': 'BRK.B', 'berkshire hathaway': 'BRK.B',
            'visa': 'V',
            'mastercard': 'MA', 'ma': 'MA',
            // Consumer
            'walmart': 'WMT', 'wmt': 'WMT',
            'disney': 'DIS', 'dis': 'DIS',
            'nike': 'NKE', 'nke': 'NKE',
            'starbucks': 'SBUX', 'sbux': 'SBUX',
            'mcdonalds': 'MCD', "mcdonald's": 'MCD', 'mcd': 'MCD',
            'coca cola': 'KO', 'coca-cola': 'KO', 'ko': 'KO',
            // Other popular
            'palantir': 'PLTR', 'pltr': 'PLTR',
            'salesforce': 'CRM', 'crm': 'CRM',
            'uber': 'UBER',
            'airbnb': 'ABNB', 'abnb': 'ABNB',
            'spotify': 'SPOT', 'spot': 'SPOT',
            'coinbase': 'COIN', 'coin': 'COIN',
            'snowflake': 'SNOW', 'snow': 'SNOW',
            'shopify': 'SHOP', 'shop': 'SHOP',
            'paypal': 'PYPL', 'pypl': 'PYPL',
            'square': 'SQ', 'block': 'SQ',
            'twitter': 'X', 'x corp': 'X',
            'amd': 'AMD',
            'openai': 'MSFT',  // OpenAI is private; surface MSFT as proxy
            'arm': 'ARM',
        };

        function extractTickers(question) {
            const tickers = new Set();
            const lower = question.toLowerCase();

            // 1. Check company name map (handles "apple", "nvidia", etc.)
            for (const [name, ticker] of Object.entries(COMPANY_MAP)) {
                // Use word boundary check to avoid partial matches
                const regex = new RegExp(`\\b${name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`);
                if (regex.test(lower)) {
                    tickers.add(ticker);
                }
            }

            // 2. Extract explicit uppercase tickers from the original question (e.g. "AAPL", "NVDA")
            const upperPattern = /\b([A-Z]{2,5})\b/g;
            const excludeWords = new Set(['I', 'A', 'THE', 'AND', 'OR', 'BUT', 'FOR', 'TO', 'IS', 'ARE',
                                          'WAS', 'WERE', 'BE', 'BEEN', 'VS', 'AT', 'IN', 'OF', 'ON',
                                          'BY', 'IF', 'SO', 'DO', 'MY', 'IT', 'ITS', 'HOW', 'WHY',
                                          'WHAT', 'WHEN', 'WHO', 'CAN', 'HAS', 'HAD', 'NOT', 'ANY',
                                          'ALL', 'NOW', 'NEW', 'TOP', 'GET', 'SET', 'BIG', 'OLD',
                                          'UP', 'AI', 'US', 'EU', 'UK', 'IPO', 'ETF', 'GDP', 'CEO',
                                          'CFO', 'COO', 'SEC', 'FED', 'ETF', 'P/E', 'EPS', 'Q1',
                                          'Q2', 'Q3', 'Q4', 'YOY', 'YTD', 'MOM']);
            const upperMatches = question.matchAll(upperPattern);
            for (const match of upperMatches) {
                const ticker = match[1];
                if (!excludeWords.has(ticker)) {
                    tickers.add(ticker);
                }
            }

            return Array.from(tickers);
        }
        
        function formatReportContent(report) {
            let html = '';
            
            if (report.market_snapshot) {
                html += '<div class="report-section">';
                html += '<h3>üìä MARKET SNAPSHOT</h3>';
                html += `<p>${report.market_snapshot}</p>`;
                html += '</div>';
            }
            
            if (report.key_drivers && report.key_drivers.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>üéØ KEY DRIVERS</h3>';
                html += '<ul>';
                report.key_drivers.forEach(driver => {
                    html += `<li>${driver}</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            
            if (report.risk_factors && report.risk_factors.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>‚ö†Ô∏è RISK FACTORS</h3>';
                html += '<ul>';
                report.risk_factors.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            
            if (report.scenarios && report.scenarios.length > 0) {
                html += '<div class="report-section">';
                html += '<h3>üîÆ SCENARIOS</h3>';
                report.scenarios.forEach(scenario => {
                    html += `<p><strong>${scenario.title}:</strong> ${scenario.description}</p>`;
                });
                html += '</div>';
            }
            
            if (report.education_context) {
                html += '<div class="report-section">';
                html += '<h3>üìö EDUCATION</h3>';
                html += `<p>${report.education_context}</p>`;
                html += '</div>';
            }
            
            if (report.comparison_tradeoffs) {
                html += '<div class="report-section">';
                html += '<h3>‚öñÔ∏è TRADEOFFS</h3>';
                html += `<p>${report.comparison_tradeoffs}</p>`;
                html += '</div>';
            }
            
            return html;
        }
        
        function addMessage(content, isUser = false, metadata = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            let messageHTML = '<div class="message-content">';
            
            if (!isUser && metadata) {
                messageHTML += '<div class="metadata-bar">';
                
                if (metadata.quality_score !== undefined) {
                    const score = metadata.quality_score;
                    const confClass = score >= 0.8 ? 'confidence-high' : 
                                     score >= 0.6 ? 'confidence-medium' : 'confidence-low';
                    messageHTML += `<span class="badge ${confClass}">QUALITY: ${(score * 100).toFixed(0)}%</span>`;
                }
                
                if (metadata.policy_status) {
                    const status = metadata.policy_status.toLowerCase();
                    const policyClass = status === 'pass' ? 'policy-pass' : 
                                       status === 'rewrite' ? 'policy-rewrite' : 'policy-fail';
                    messageHTML += `<span class="badge ${policyClass}">POLICY: ${metadata.policy_status}</span>`;
                }
                
                if (metadata.report_type) {
                    messageHTML += `<span class="badge report-type">${metadata.report_type}</span>`;
                }
                
                messageHTML += '</div>';
            }
            
            if (typeof content === 'string') {
                const formattedContent = content.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
                messageHTML += formattedContent;
            } else {
                messageHTML += formatReportContent(content);
            }
            
            if (!isUser && metadata && metadata.follow_up_questions && metadata.follow_up_questions.length > 0) {
                messageHTML += '<div class="followup-buttons">';
                metadata.follow_up_questions.forEach(q => {
                    messageHTML += `<button class="followup-btn" onclick='askQuestion("${q.replace(/"/g, '&quot;')}")'>${q}</button>`;
                });
                messageHTML += '</div>';
            }
            
            if (!isUser && metadata && metadata.citations && metadata.citations.length > 0) {
                messageHTML += '<div class="citations">';
                messageHTML += '<div class="citations-title">CITATIONS:</div>';
                metadata.citations.forEach(citation => {
                    messageHTML += `<a href="${citation.url}" target="_blank" class="citation-link">${citation.title}</a>`;
                });
                messageHTML += '</div>';
            }
            
            if (!isUser && metadata && metadata.trace_id) {
                messageHTML += `<div class="trace-id">trace: ${metadata.trace_id}</div>`;
            }
            
            messageHTML += '</div>';
            messageDiv.innerHTML = messageHTML;
            chatContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                const rect = messageDiv.getBoundingClientRect();
                const containerRect = chatContainer.getBoundingClientRect();
                const scrollOffset = rect.top - containerRect.top + chatContainer.scrollTop - 10;
                chatContainer.scrollTo({top: scrollOffset, behavior: 'smooth'});
            }, 50);
        }
        
        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = `
                <div class="message-content loading">
                    <span>PROCESSING PIPELINE</span>
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function removeLoadingMessage() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }
        
        // ========================================================================
        // SEND MESSAGE - FIXED!
        // ========================================================================
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const question = input.value.trim();
            
            if (!question) return;
            
            const welcome = document.querySelector('.welcome-message');
            if (welcome) welcome.remove();
            
            addMessage(question, true);
            
            input.value = '';
            sendBtn.disabled = true;
            
            addLoadingMessage();
            
            try {
                // FIXED: Extract tickers from question
                const tickers = extractTickers(question);
                console.log('üéØ Extracted tickers:', tickers);
                
                const response = await fetch(`${API_URL}/api/generate-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        tickers: tickers  // ‚Üê FIXED: Use extracted tickers instead of []
                    })
                });
                
                const data = await response.json();
                
                console.log('Backend response:', data);
                
                removeLoadingMessage();
                
                if (data.success) {
                    const report = data.report;
                    
                    // Extract quality score from quality object
                    const qualityScore = report.quality ? (
                        report.quality.data_integrity === 'excellent' ? 0.9 :
                        report.quality.data_integrity === 'good' ? 0.7 :
                        report.quality.data_integrity === 'fair' ? 0.5 : 0.3
                    ) : undefined;
                    
                    const metadata = {
                        quality_score: qualityScore,
                        policy_status: report.quality ? report.quality.policy_status : undefined,
                        report_type: report.report_type,
                        follow_up_questions: (report.followups || []).map(f => f.question),
                        citations: (report.sources || []).map(s => ({
                            title: s.title,
                            url: s.url || '#'
                        })),
                        trace_id: report.trace_id
                    };
                    
                    // Pass the markdown content, not the whole report object
                    addMessage(report.answer_markdown || report, false, metadata);
                } else {
                    addMessage(`<div class="error-message">${data.error || 'An error occurred'}</div>`, false);
                }
                
            } catch (error) {
                removeLoadingMessage();
                addMessage(`<div class="error-message">CONNECTION ERROR: Backend not responding at ${API_URL}<br><br>Make sure the server is running.</div>`, false);
            }
            
            sendBtn.disabled = false;
            input.focus();
        }
        
        function askQuestion(question) {
            document.getElementById('userInput').value = question;
            sendMessage();
        }
    </script>
</body>
</html>
